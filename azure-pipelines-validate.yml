trigger:
- main

pr:
- main

variables:
  renovateConfigFile: 'renovate.json'

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Validate
  displayName: 'Validate Renovate Configuration'
  jobs:
  - job: ValidateConfig
    displayName: 'Validate Renovate Config'
    steps:
    - checkout: self

    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: '18.x'

    - script: |
        npm install -g renovate
      displayName: 'Install Renovate'

    - script: |
        echo "Validating Renovate configuration..."
        if [ ! -f "$(renovateConfigFile)" ]; then
          echo "âŒ renovate.json not found!"
          exit 1
        fi
        
        echo "âœ… renovate.json file exists"
        
        # Validate JSON syntax
        if cat $(renovateConfigFile) | python -m json.tool > /dev/null; then
          echo "âœ… renovate.json has valid JSON syntax"
        else
          echo "âŒ renovate.json has invalid JSON syntax"
          exit 1
        fi
      displayName: 'Basic Validation'

    - script: |
        echo "Running Renovate config validation..."
        renovate-config-validator $(renovateConfigFile)
      displayName: 'Renovate Config Validation'
      continueOnError: true

    - script: |
        echo "ğŸ‰ Renovate Configuration Summary:"
        echo "=================================="
        echo "ğŸ“… Schedule: Weekly on Mondays at 2:30 AM UTC"
        echo "ğŸ”„ Auto-merge: Enabled for patch updates"
        echo "âœ‹ Manual approval: Required for major updates"
        echo "ğŸŒ Environment-specific rules: Configured"
        echo "ğŸ”’ Security updates: Prioritized"
        echo "ğŸ“Š Dependency dashboard: Enabled"
        echo "ğŸ·ï¸  Labels: renovate"
        echo "ğŸ“ Semantic commits: Enabled"
        echo ""
        echo "Platform Support:"
        echo "- âœ… GitHub Actions workflow included"
        echo "- âœ… Azure DevOps pipeline included"
        echo ""
        echo "Monitored Dependencies:"
        echo "- ğŸ“¦ Helm Charts (cert-manager, external-secrets, ingress-nginx, kube-prometheus-stack, podinfo)"
        echo "- ğŸ³ Container Images (automatic detection)"
        echo "- âš¡ Flux Components"
        echo "- ğŸ“„ Kubernetes YAML manifests"
      displayName: 'Configuration Summary'

    - task: PublishTestResults@2
      displayName: 'Publish Validation Results'
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/renovate-validation.xml'
        failTaskOnFailedTests: false
      continueOnError: true
